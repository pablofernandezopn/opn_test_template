import 'package:flutter_bloc/flutter_bloc.dart';
import '../model/chat_message_model.dart';
import '../model/message_model.dart';
import '../repository/conversation_repository.dart';
import 'ai_chat_state.dart';

/// Cubit para manejar el estado del chat con IA
class AiChatCubit extends Cubit<AiChatState> {
  final ConversationRepository _conversationRepository;
  final int _userId;

  AiChatCubit({
    required ConversationRepository conversationRepository,
    required int userId,
    String? initialContext,
    int? conversationId,
  })  : _conversationRepository = conversationRepository,
        _userId = userId,
        super(AiChatState(conversationId: conversationId)) {
    _initialize(initialContext, conversationId);
  }

  /// Inicializa el chat
  Future<void> _initialize(String? initialContext, int? conversationId) async {
    if (conversationId != null) {
      // Cargar conversaci√≥n existente
      await _loadExistingConversation(conversationId);
    } else {
      // Crear nueva conversaci√≥n
      await _createNewConversation(initialContext);
    }
  }

  /// Crea una nueva conversaci√≥n
  Future<void> _createNewConversation(String? initialContext) async {
    try {
      final conversation = await _conversationRepository.createConversation(
        userId: _userId,
        title: initialContext != null ? 'Pregunta sobre: ${initialContext.substring(0, 50)}...' : null,
      );

      emit(state.copyWith(conversationId: conversation.id));

      // Si hay contexto inicial, agregar mensaje de bienvenida
      if (initialContext != null && initialContext.isNotEmpty) {
        final welcomeMessage = ChatMessageX.assistant(
          'Hola, soy tu asistente de IA. Estoy aqu√≠ para ayudarte con esta pregunta:\n\n$initialContext\n\n¬øEn qu√© puedo ayudarte?',
        );
        emit(state.copyWith(messages: [welcomeMessage]));

        // Guardar mensaje de bienvenida en la BD
        await _conversationRepository.createMessage(
          conversationId: conversation.id,
          role: MessageRoleDb.assistant,
          content: welcomeMessage.content,
        );
      }
    } catch (e) {
      emit(state.copyWith(
        hasError: true,
        errorMessage: 'Error al crear la conversaci√≥n',
      ));
    }
  }

  /// Carga una conversaci√≥n existente
  Future<void> _loadExistingConversation(int conversationId) async {
    try {
      final messages = await _conversationRepository.getConversationMessages(conversationId);

      final chatMessages = messages.map((msg) {
        return ChatMessage(
          id: msg.id.toString(),
          content: msg.content,
          role: _convertDbRoleToMessageRole(msg.role),
          timestamp: msg.createdAt,
        );
      }).toList();

      emit(state.copyWith(messages: chatMessages));
    } catch (e) {
      emit(state.copyWith(
        hasError: true,
        errorMessage: 'Error al cargar la conversaci√≥n',
      ));
    }
  }

  /// Convierte MessageRoleDb a MessageRole
  MessageRole _convertDbRoleToMessageRole(MessageRoleDb dbRole) {
    switch (dbRole) {
      case MessageRoleDb.user:
        return MessageRole.user;
      case MessageRoleDb.assistant:
        return MessageRole.assistant;
      case MessageRoleDb.system:
        return MessageRole.system;
      case MessageRoleDb.function:
        return MessageRole.system; // Mapear function a system
    }
  }

  /// Convierte MessageRole a MessageRoleDb
  MessageRoleDb _convertMessageRoleToDbRole(MessageRole role) {
    switch (role) {
      case MessageRole.user:
        return MessageRoleDb.user;
      case MessageRole.assistant:
        return MessageRoleDb.assistant;
      case MessageRole.system:
        return MessageRoleDb.system;
    }
  }

  /// Env√≠a un mensaje del usuario
  Future<void> sendMessage(String content) async {
    if (content.trim().isEmpty) return;
    if (state.conversationId == null) {
      emit(state.copyWith(
        hasError: true,
        errorMessage: 'No hay una conversaci√≥n activa',
      ));
      return;
    }

    // Agregar mensaje del usuario
    final userMessage = ChatMessageX.user(content);
    emit(state.copyWith(
      messages: [...state.messages, userMessage],
      isLoading: true,
    ));

    try {
      // Guardar mensaje del usuario en la BD
      await _conversationRepository.createMessage(
        conversationId: state.conversationId!,
        role: MessageRoleDb.user,
        content: content,
      );

      // Simular delay de la API
      await Future.delayed(const Duration(milliseconds: 1500));

      // Aqu√≠ ir√≠a la llamada real a la API de IA
      // Por ahora, simulamos una respuesta
      final aiResponse = _generateMockResponse(content);
      final assistantMessage = ChatMessageX.assistant(aiResponse);

      // Guardar respuesta del asistente en la BD
      await _conversationRepository.createMessage(
        conversationId: state.conversationId!,
        role: MessageRoleDb.assistant,
        content: aiResponse,
      );

      emit(state.copyWith(
        messages: [...state.messages, assistantMessage],
        isLoading: false,
      ));
    } catch (e) {
      emit(state.copyWith(
        isLoading: false,
        hasError: true,
        errorMessage: 'Error al procesar tu mensaje. Int√©ntalo de nuevo.',
      ));
    }
  }

  /// Genera una respuesta simulada (temporal hasta integrar IA real)
  String _generateMockResponse(String userMessage) {
    final lowerMessage = userMessage.toLowerCase();

    // Saludos
    if (lowerMessage.contains('hola') ||
        lowerMessage.contains('buenas') ||
        lowerMessage.contains('hey')) {
      return '¬°Hola! üëã Estoy aqu√≠ para ayudarte a entender mejor esta pregunta y prepararte para tu examen. ¬øQu√© te gustar√≠a saber?';
    }

    // Explicaciones
    if (lowerMessage.contains('explicar') ||
        lowerMessage.contains('explica') ||
        lowerMessage.contains('qu√© significa') ||
        lowerMessage.contains('que significa') ||
        lowerMessage.contains('no entiendo')) {
      return 'üìö Te explico:\n\nEsta pregunta eval√∫a un concepto fundamental del temario. Para comprenderla mejor:\n\n1. **Contexto**: Identifica el √°rea tem√°tica espec√≠fica\n2. **Conceptos clave**: F√≠jate en las palabras importantes del enunciado\n3. **Razonamiento**: Cada opci√≥n tiene una raz√≥n de ser correcta o incorrecta\n\nüí° **Tip**: Intenta relacionar la pregunta con situaciones pr√°cticas del cuerpo. Esto te ayudar√° a recordar mejor.\n\n¬øHay alg√∫n t√©rmino espec√≠fico que no entiendas?';
    }

    // Ayuda general
    if (lowerMessage.contains('ayuda') || lowerMessage.contains('ay√∫dame')) {
      return 'ü§ù Estoy aqu√≠ para ayudarte. Puedo:\n\n‚Ä¢ üìñ Explicarte conceptos y t√©rminos legales\n‚Ä¢ üí≠ Ayudarte a razonar entre las opciones\n‚Ä¢ üéØ Darte t√©cnicas de memorizaci√≥n\n‚Ä¢ üìù Sugerirte recursos complementarios\n‚Ä¢ üîç Aclarar dudas sobre procedimientos\n\n¬øCon qu√© aspecto espec√≠fico necesitas ayuda?';
    }

    // Opciones y razonamiento
    if (lowerMessage.contains('opci√≥n') ||
        lowerMessage.contains('respuesta') ||
        lowerMessage.contains('correcta')) {
      return 'üéØ Sobre las opciones:\n\nNo puedo decirte directamente cu√°l es la correcta (eso eliminar√≠a el prop√≥sito del test), pero s√≠ puedo ayudarte a:\n\n‚Ä¢ Analizar cada opci√≥n sistem√°ticamente\n‚Ä¢ Identificar palabras clave que puedan darte pistas\n‚Ä¢ Descartar opciones claramente incorrectas\n‚Ä¢ Aplicar t√©cnicas de razonamiento l√≥gico\n\n¬øQuieres que analicemos las opciones juntos? Dime cu√°l te genera m√°s dudas.';
    }

    // T√©cnicas de estudio
    if (lowerMessage.contains('memorizar') ||
        lowerMessage.contains('recordar') ||
        lowerMessage.contains('t√©cnica') ||
        lowerMessage.contains('trucos')) {
      return 'üß† T√©cnicas para memorizar:\n\n**1. Mnemotecnia**: Crea acr√≥nimos o frases con las iniciales\n**2. Visualizaci√≥n**: Asocia conceptos con im√°genes mentales\n**3. Repetici√≥n espaciada**: Repasa en intervalos crecientes\n**4. Contextualizaci√≥n**: Relaciona con casos pr√°cticos reales\n**5. Mapas mentales**: Organiza la informaci√≥n visualmente\n\nüí° Para esta pregunta espec√≠fica, te recomendar√≠a usar la t√©cnica de contextualizaci√≥n: imagina una situaci√≥n real donde aplicar√≠as este conocimiento.\n\n¬øTe gustar√≠a que profundice en alguna t√©cnica?';
    }

    // Leyes y normativa
    if (lowerMessage.contains('ley') ||
        lowerMessage.contains('art√≠culo') ||
        lowerMessage.contains('articulo') ||
        lowerMessage.contains('c√≥digo') ||
        lowerMessage.contains('normativa')) {
      return '‚öñÔ∏è Sobre normativa legal:\n\nLas preguntas de normativa pueden parecer complicadas, pero hay una estrategia:\n\n1. **Identifica la norma**: ¬øQu√© ley o c√≥digo aplica?\n2. **Contexto temporal**: ¬øEs normativa vigente o hist√≥rica?\n3. **Jerarqu√≠a normativa**: Constituci√≥n > Ley Org√°nica > Ley Ordinaria > Reglamento\n4. **Palabras exactas**: En derecho, la precisi√≥n importa\n\nüìå **Consejo**: Si dudas entre dos opciones normativas, la m√°s espec√≠fica suele ser correcta.\n\n¬øNecesitas ayuda con alg√∫n aspecto concreto de la normativa?';
    }

    // Procedimientos
    if (lowerMessage.contains('procedimiento') ||
        lowerMessage.contains('paso') ||
        lowerMessage.contains('orden') ||
        lowerMessage.contains('secuencia')) {
      return 'üîÑ Sobre procedimientos:\n\nLos procedimientos siguen siempre una l√≥gica:\n\n1. **Inicio**: ¬øQu√© desencadena el procedimiento?\n2. **Competencia**: ¬øQui√©n tiene autoridad?\n3. **Fases**: ¬øQu√© pasos son obligatorios?\n4. **Plazos**: ¬øHay l√≠mites temporales?\n5. **Resoluci√≥n**: ¬øC√≥mo termina?\n\nüí° **Tip mental**: Imag√≠nate ejecutando el procedimiento paso a paso, como si fueras el agente encargado.\n\n¬øHay alg√∫n paso del procedimiento que te confunda?';
    }

    // Delitos y faltas
    if (lowerMessage.contains('delito') ||
        lowerMessage.contains('falta') ||
        lowerMessage.contains('sanci√≥n') ||
        lowerMessage.contains('pena')) {
      return '‚ö†Ô∏è Sobre delitos y sanciones:\n\nPara diferenciar conceptos penales:\n\n**Elementos clave:**\n‚Ä¢ **Tipicidad**: ¬øEst√° descrito en el c√≥digo penal?\n‚Ä¢ **Antijuridicidad**: ¬øEs contrario a derecho?\n‚Ä¢ **Culpabilidad**: ¬øHay intenci√≥n o negligencia?\n‚Ä¢ **Penalidad**: ¬øQu√© tipo de sanci√≥n corresponde?\n\nüìñ **Clasificaci√≥n**:\n- Delitos graves: pena > 5 a√±os\n- Delitos menos graves: pena 3 meses - 5 a√±os  \n- Delitos leves: pena < 3 meses\n\n¬øNecesitas que profundice en alg√∫n aspecto espec√≠fico?';
    }

    // Dudas entre opciones
    if (lowerMessage.contains('dudo') ||
        lowerMessage.contains('no s√©') ||
        lowerMessage.contains('no se') ||
        lowerMessage.contains('entre')) {
      return 'ü§î Cuando dudes entre opciones:\n\n**Estrategia de descarte:**\n\n1. **Elimina las claramente falsas**: A veces hay opciones absurdas\n2. **Busca palabras absolutas**: "Siempre", "nunca", "todos" ‚Üí sospechosas\n3. **Identifica contradicciones**: ¬øHay opciones que se contradicen?\n4. **Conf√≠a en tu primera impresi√≥n**: Si estudiaste, tu intuici√≥n importa\n5. **Lee bien el enunciado**: ¬øQu√© pregunta EXACTAMENTE?\n\n‚ö° **Si quedan dos opciones**: La que sea m√°s espec√≠fica y precisa suele ser correcta.\n\n¬øQuieres que analicemos juntos las opciones?';
    }

    // Conceptos generales de Guardia Civil
    if (lowerMessage.contains('guardia civil') ||
        lowerMessage.contains('cuerpo') ||
        lowerMessage.contains('instituto armado')) {
      return 'üá™üá∏ Sobre la Guardia Civil:\n\nConceptos importantes:\n\n**Naturaleza jur√≠dica**: Instituto armado de naturaleza militar\n**Dependencia**: Ministerio del Interior (funcionamiento ordinario)\n**Misiones principales**:\n‚Ä¢ Seguridad ciudadana\n‚Ä¢ Tr√°fico y seguridad vial\n‚Ä¢ Protecci√≥n de la naturaleza\n‚Ä¢ Polic√≠a judicial\n‚Ä¢ Misiones internacionales\n\nüìã **Normativa clave**:\n- Ley Org√°nica 2/1986\n- Ley 29/2014 de R√©gimen del Personal\n\n¬øNecesitas informaci√≥n sobre alg√∫n aspecto concreto del Cuerpo?';
    }

    // Constituci√≥n
    if (lowerMessage.contains('constituci√≥n') ||
        lowerMessage.contains('constitucion') ||
        lowerMessage.contains('derechos fundamentales')) {
      return 'üìú Sobre la Constituci√≥n:\n\n**Estructura b√°sica:**\n\n‚Ä¢ **T√≠tulo Preliminar**: Principios fundamentales\n‚Ä¢ **T√≠tulo I**: Derechos y deberes fundamentales (arts. 10-55)\n‚Ä¢ **T√≠tulos II-IX**: Organizaci√≥n del Estado\n‚Ä¢ **Disposiciones adicionales y transitorias**\n\nüîë **Conceptos clave:**\n- Derechos fundamentales (arts. 15-29): M√°xima protecci√≥n\n- Derechos ciudadanos (arts. 30-38): Protecci√≥n ordinaria  \n- Principios rectores (arts. 39-52): Orientan legislaci√≥n\n\nüí° Para las oposiciones, c√©ntrate especialmente en el T√≠tulo I.\n\n¬øQu√© art√≠culo o derecho te genera dudas?';
    }

    // Agradecimientos
    if (lowerMessage.contains('gracias') ||
        lowerMessage.contains('vale') ||
        lowerMessage.contains('ok') ||
        lowerMessage.contains('entendido')) {
      return '¬°De nada! üòä Me alegro de haberte ayudado.\n\nRecuerda:\n‚Ä¢ La pr√°ctica constante es clave\n‚Ä¢ Revisa tus errores para aprender\n‚Ä¢ Descansa bien antes del examen\n\n¬øHay algo m√°s en lo que pueda ayudarte con esta pregunta?';
    }

    // √Ånimos
    if (lowerMessage.contains('dif√≠cil') ||
        lowerMessage.contains('dificil') ||
        lowerMessage.contains('complicado') ||
        lowerMessage.contains('no puedo')) {
      return 'üí™ ¬°No te desanimes!\n\nTodas las preguntas son complejas al principio, pero:\n\n‚ú® **Recuerda**: Cada pregunta que practicas es una que dominar√°s en el examen\nüéØ **Estrategia**: Divide la pregunta en partes m√°s peque√±as\nüìö **Aprendizaje**: Los errores son oportunidades de mejora\n‚è∞ **Tiempo**: Con pr√°ctica, ir√°s m√°s r√°pido y seguro\n\n¬°T√∫ puedes con esto y mucho m√°s! El hecho de estar practicando ya te pone muy por delante.\n\n¬øVamos paso a paso con esta pregunta?';
    }

    // Respuesta por defecto m√°s elaborada
    return 'ü§ñ Entiendo tu pregunta.\n\nPara ayudarte mejor, podr√≠as especificarme:\n\n‚Ä¢ ¬øQu√© parte espec√≠fica no entiendes?\n‚Ä¢ ¬øEs un t√©rmino, un concepto o el razonamiento completo?\n‚Ä¢ ¬øHas identificado alguna opci√≥n que puedas descartar?\n‚Ä¢ ¬øHay alguna palabra clave que te confunda?\n\nCuanto m√°s espec√≠fico seas, mejor podr√© orientarte. Estoy aqu√≠ para ayudarte a razonar, no solo a memorizar. üòä';
  }

  /// Limpia el historial de mensajes
  void clearMessages() {
    emit(const AiChatState());
  }

  /// Elimina el mensaje de error
  void clearError() {
    emit(state.copyWith(hasError: false, errorMessage: null));
  }
}